<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:zeebe="http://camunda.org/schema/zeebe/1.0" id="Definitions_GaniPay_TopUp_v1" targetNamespace="http://ganipay.local/bpmn" exporter="Camunda Modeler" exporterVersion="5.40.1">
  <bpmn:process id="topup" name="TopUp" isExecutable="true">
    <bpmn:intermediateThrowEvent id="Event_AccountFailed" name="Account Failed">
      <bpmn:incoming>Flow_0cw67z9</bpmn:incoming>
      <bpmn:outgoing>Flow_AccountFailed_To_EndJoin</bpmn:outgoing>
      <bpmn:outgoing>Flow_1x35g4y</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:exclusiveGateway id="Gw_AccountOk" name="Account OK" default="Flow_0cw67z9">
      <bpmn:incoming>Flow_AccountStatus_To_Gw_Account</bpmn:incoming>
      <bpmn:outgoing>Flow_AccountOk_To_LimitCheck</bpmn:outgoing>
      <bpmn:outgoing>Flow_0cw67z9</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:serviceTask id="Task_AccountStatus" name="Account Status Check">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="accounting.account.status.check" retries="3" />
        <zeebe:ioMapping>
          <zeebe:input source="=accountId" target="accountId" />
          <zeebe:input source="=customerId" target="customerId" />
          <zeebe:input source="=currency" target="currency" />
          <zeebe:output source="=accountOk" target="accountOk" />
          <zeebe:output source="=status" target="accountStatus" />
          <zeebe:output source="=accountStatusText" target="accountStatusText" />
          <zeebe:output source="=errorCode" target="errorCode" />
          <zeebe:output source="=errorMessage" target="errorMessage" />
          <zeebe:output source="=failedAtStep" target="failedAtStep" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ValidateOk_To_AccountStatus</bpmn:incoming>
      <bpmn:outgoing>Flow_AccountStatus_To_Gw_Account</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="Task_PersistResult" name="Complete TopUp">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="payments.topup.complete" retries="3" />
        <zeebe:ioMapping>
          <zeebe:input source="=paymentCorrelationId" target="correlationId" />
          <zeebe:input source="=creditOk" target="creditOk" />
          <zeebe:input source="=errorCode" target="errorCode" />
          <zeebe:input source="=errorMessage" target="errorMessage" />
          <zeebe:output source="=persistOk" target="persistOk" />
          <zeebe:output source="=ok" target="paymentsStatusUpdated" />
          <zeebe:output source="=errorCode" target="errorCode" />
          <zeebe:output source="=errorMessage" target="errorMessage" />
          <zeebe:output source="=failedAtStep" target="failedAtStep" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_CreditOk_To_Persist</bpmn:incoming>
      <bpmn:outgoing>Flow_Persist_To_Gw_Persist</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:intermediateThrowEvent id="Event_CreditFailed" name="Credit Failed">
      <bpmn:incoming>Flow_0r2ms3z</bpmn:incoming>
      <bpmn:outgoing>Flow_CreditFailed_To_EndJoin</bpmn:outgoing>
      <bpmn:outgoing>Flow_18x9sla</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:serviceTask id="Task_CreditLedger" name="Credit Ledger">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="accounting.topup.credit" retries="3" />
        <zeebe:ioMapping>
          <zeebe:input source="=accountId" target="accountId" />
          <zeebe:input source="=amount" target="amount" />
          <zeebe:input source="=currency" target="currency" />
          <zeebe:input source="=2" target="direction" />
          <zeebe:input source="=1" target="operationType" />
          <zeebe:input source="=paymentCorrelationId" target="referenceId" />
          <zeebe:output source="=creditOk" target="creditOk" />
          <zeebe:output source="=id" target="accountingTxId" />
          <zeebe:output source="=balanceBefore" target="balanceBefore" />
          <zeebe:output source="=balanceAfter" target="balanceAfter" />
          <zeebe:output source="=createdAt" target="ledgerCreatedAt" />
          <zeebe:output source="=referenceId" target="ledgerReferenceId" />
          <zeebe:output source="=operationType" target="ledgerOperationType" />
          <zeebe:output source="=errorCode" target="errorCode" />
          <zeebe:output source="=errorMessage" target="errorMessage" />
          <zeebe:output source="=failedAtStep" target="failedAtStep" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ProviderOk_To_Credit</bpmn:incoming>
      <bpmn:outgoing>Flow_Credit_To_Gw_Credit</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:exclusiveGateway id="Gw_CreditOk" name="Credit OK" default="Flow_0r2ms3z">
      <bpmn:incoming>Flow_Credit_To_Gw_Credit</bpmn:incoming>
      <bpmn:outgoing>Flow_CreditOk_To_Persist</bpmn:outgoing>
      <bpmn:outgoing>Flow_0r2ms3z</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:endEvent id="EndEvent_TopUp" name="End">
      <bpmn:incoming>Flow_0fc3unq</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:exclusiveGateway id="Gw_EndJoin" name="End Join">
      <bpmn:incoming>Flow_ValidateFailed_To_EndJoin</bpmn:incoming>
      <bpmn:incoming>Flow_AccountFailed_To_EndJoin</bpmn:incoming>
      <bpmn:incoming>Flow_LimitFailed_To_EndJoin</bpmn:incoming>
      <bpmn:incoming>Flow_OrderFailed_To_EndJoin</bpmn:incoming>
      <bpmn:incoming>Flow_ProviderFailed_To_EndJoin</bpmn:incoming>
      <bpmn:incoming>Flow_CreditFailed_To_EndJoin</bpmn:incoming>
      <bpmn:incoming>Flow_PersistFailed_To_EndJoin</bpmn:incoming>
      <bpmn:incoming>Flow_NotifyFailed_To_EndJoin</bpmn:incoming>
      <bpmn:incoming>Flow_0r9564w</bpmn:incoming>
      <bpmn:incoming>Flow_1jmuvxb</bpmn:incoming>
      <bpmn:incoming>Flow_1x35g4y</bpmn:incoming>
      <bpmn:incoming>Flow_16bwcff</bpmn:incoming>
      <bpmn:incoming>Flow_1xrcphi</bpmn:incoming>
      <bpmn:incoming>Flow_0ni831r</bpmn:incoming>
      <bpmn:incoming>Flow_18x9sla</bpmn:incoming>
      <bpmn:incoming>Flow_0k0fk85</bpmn:incoming>
      <bpmn:incoming>Flow_0t8nc1l</bpmn:incoming>
      <bpmn:outgoing>Flow_0fc3unq</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_08fjqvi" sourceRef="Gw_PersistOk" targetRef="Event_PersistFailed" />
    <bpmn:sequenceFlow id="Flow_09935eq" sourceRef="Gw_ValidateOk" targetRef="Event_ValidateFailed" />
    <bpmn:sequenceFlow id="Flow_0c9zx24" sourceRef="Gw_LimitOk" targetRef="Event_LimitFailed" />
    <bpmn:sequenceFlow id="Flow_0cw67z9" sourceRef="Gw_AccountOk" targetRef="Event_AccountFailed" />
    <bpmn:sequenceFlow id="Flow_0fc3unq" sourceRef="Gw_EndJoin" targetRef="EndEvent_TopUp" />
    <bpmn:sequenceFlow id="Flow_0gsl0hg" sourceRef="Task_ValidateRequest" targetRef="Gw_ValidateOk" />
    <bpmn:sequenceFlow id="Flow_0k0fk85" sourceRef="Event_PersistFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_0ni831r" sourceRef="Event_ProviderFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_0r2ms3z" sourceRef="Gw_CreditOk" targetRef="Event_CreditFailed" />
    <bpmn:sequenceFlow id="Flow_0r9564w" sourceRef="Event_TopUpSuccess" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_0s90190" sourceRef="Gw_OrderOk" targetRef="Event_OrderFailed" />
    <bpmn:sequenceFlow id="Flow_0t8nc1l" sourceRef="Event_NotifyFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_15v3udl" sourceRef="Task_OrderCreate" targetRef="Gw_OrderOk" />
    <bpmn:sequenceFlow id="Flow_16bwcff" sourceRef="Event_LimitFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_18x9sla" sourceRef="Event_CreditFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_1dl7hhq" sourceRef="StartEvent_TopUp" targetRef="Task_ValidateRequest" />
    <bpmn:sequenceFlow id="Flow_1jmuvxb" sourceRef="Event_ValidateFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_1meuv2q" sourceRef="Gw_NotifyOk" targetRef="Event_NotifyFailed" />
    <bpmn:sequenceFlow id="Flow_1vfutif" sourceRef="Task_LimitCheck" targetRef="Gw_LimitOk" />
    <bpmn:sequenceFlow id="Flow_1x35g4y" sourceRef="Event_AccountFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_1xrcphi" sourceRef="Event_OrderFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_AccountFailed_To_EndJoin" sourceRef="Event_AccountFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_AccountOk_To_LimitCheck" sourceRef="Gw_AccountOk" targetRef="Task_LimitCheck">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=accountOk=true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_AccountStatus_To_Gw_Account" sourceRef="Task_AccountStatus" targetRef="Gw_AccountOk" />
    <bpmn:sequenceFlow id="Flow_Credit_To_Gw_Credit" sourceRef="Task_CreditLedger" targetRef="Gw_CreditOk" />
    <bpmn:sequenceFlow id="Flow_CreditFailed_To_EndJoin" sourceRef="Event_CreditFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_CreditOk_To_Persist" sourceRef="Gw_CreditOk" targetRef="Task_PersistResult">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=creditOk=true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_LimitFailed_To_EndJoin" sourceRef="Event_LimitFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_LimitOk_To_OrderCreate" sourceRef="Gw_LimitOk" targetRef="Task_OrderCreate">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=limitOk=true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_Notify_To_Gw_Notify" sourceRef="Task_SendNotification" targetRef="Gw_NotifyOk" />
    <bpmn:sequenceFlow id="Flow_NotifyFailed_To_EndJoin" sourceRef="Event_NotifyFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_NotifyOk_To_Success" sourceRef="Gw_NotifyOk" targetRef="Event_TopUpSuccess">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=notifyOk=true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_OrderFailed_To_EndJoin" sourceRef="Event_OrderFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_OrderOk_To_Provider" sourceRef="Gw_OrderOk" targetRef="Task_ProviderCharge">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=orderOk=true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_Persist_To_Gw_Persist" sourceRef="Task_PersistResult" targetRef="Gw_PersistOk" />
    <bpmn:sequenceFlow id="Flow_PersistFailed_To_EndJoin" sourceRef="Event_PersistFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_PersistOk_To_Notify" sourceRef="Gw_PersistOk" targetRef="Task_SendNotification">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=persistOk=true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_Provider_To_Gw_Provider" sourceRef="Task_ProviderCharge" targetRef="Gw_ProviderOk" />
    <bpmn:sequenceFlow id="Flow_ProviderFail_To_ProviderFailed" sourceRef="Gw_ProviderOk" targetRef="Event_ProviderFailed" />
    <bpmn:sequenceFlow id="Flow_ProviderFailed_To_EndJoin" sourceRef="Event_ProviderFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_ProviderOk_To_Credit" sourceRef="Gw_ProviderOk" targetRef="Task_CreditLedger">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=providerOk=true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ValidateFailed_To_EndJoin" sourceRef="Event_ValidateFailed" targetRef="Gw_EndJoin" />
    <bpmn:sequenceFlow id="Flow_ValidateOk_To_AccountStatus" sourceRef="Gw_ValidateOk" targetRef="Task_AccountStatus">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=validateOk=true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:serviceTask id="Task_OrderCreate" name="Initiate TopUp">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="payments.topup.initiate" retries="3" />
        <zeebe:ioMapping>
          <zeebe:input source="=customerId" target="customerId" />
          <zeebe:input source="=amount" target="amount" />
          <zeebe:input source="=currency" target="currency" />
          <zeebe:input source="=idempotencyKey" target="idempotencyKey" />
          <zeebe:input source="=correlationId" target="workflowCorrelationId" />
          <zeebe:output source="=orderOk" target="orderOk" />
          <zeebe:output source="=correlationId" target="paymentCorrelationId" />
          <zeebe:output source="=status" target="paymentStatus" />
          <zeebe:output source="=errorCode" target="errorCode" />
          <zeebe:output source="=errorMessage" target="errorMessage" />
          <zeebe:output source="=failedAtStep" target="failedAtStep" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_LimitOk_To_OrderCreate</bpmn:incoming>
      <bpmn:outgoing>Flow_15v3udl</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:intermediateThrowEvent id="Event_LimitFailed" name="Limit Failed">
      <bpmn:incoming>Flow_0c9zx24</bpmn:incoming>
      <bpmn:outgoing>Flow_LimitFailed_To_EndJoin</bpmn:outgoing>
      <bpmn:outgoing>Flow_16bwcff</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:exclusiveGateway id="Gw_LimitOk" name="Limit OK" default="Flow_0c9zx24">
      <bpmn:incoming>Flow_1vfutif</bpmn:incoming>
      <bpmn:outgoing>Flow_LimitOk_To_OrderCreate</bpmn:outgoing>
      <bpmn:outgoing>Flow_0c9zx24</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:intermediateThrowEvent id="Event_NotifyFailed" name="Notify Failed">
      <bpmn:incoming>Flow_1meuv2q</bpmn:incoming>
      <bpmn:outgoing>Flow_NotifyFailed_To_EndJoin</bpmn:outgoing>
      <bpmn:outgoing>Flow_0t8nc1l</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:exclusiveGateway id="Gw_NotifyOk" name="Notify OK" default="Flow_1meuv2q">
      <bpmn:incoming>Flow_Notify_To_Gw_Notify</bpmn:incoming>
      <bpmn:outgoing>Flow_NotifyOk_To_Success</bpmn:outgoing>
      <bpmn:outgoing>Flow_1meuv2q</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:intermediateThrowEvent id="Event_OrderFailed" name="Order Failed">
      <bpmn:incoming>Flow_0s90190</bpmn:incoming>
      <bpmn:outgoing>Flow_OrderFailed_To_EndJoin</bpmn:outgoing>
      <bpmn:outgoing>Flow_1xrcphi</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:exclusiveGateway id="Gw_OrderOk" name="Order OK" default="Flow_0s90190">
      <bpmn:incoming>Flow_15v3udl</bpmn:incoming>
      <bpmn:outgoing>Flow_OrderOk_To_Provider</bpmn:outgoing>
      <bpmn:outgoing>Flow_0s90190</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:intermediateThrowEvent id="Event_PersistFailed" name="Persist Failed">
      <bpmn:incoming>Flow_08fjqvi</bpmn:incoming>
      <bpmn:outgoing>Flow_PersistFailed_To_EndJoin</bpmn:outgoing>
      <bpmn:outgoing>Flow_0k0fk85</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:exclusiveGateway id="Gw_PersistOk" name="Persist OK" default="Flow_08fjqvi">
      <bpmn:incoming>Flow_Persist_To_Gw_Persist</bpmn:incoming>
      <bpmn:outgoing>Flow_PersistOk_To_Notify</bpmn:outgoing>
      <bpmn:outgoing>Flow_08fjqvi</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:serviceTask id="Task_ProviderCharge" name="Provider Charge">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="mock.topup.provider.charge" retries="3" />
        <zeebe:ioMapping>
          <zeebe:input source="=paymentCorrelationId" target="paymentCorrelationId" />
          <zeebe:input source="=customerId" target="customerId" />
          <zeebe:input source="=amount" target="amount" />
          <zeebe:input source="=currency" target="currency" />
          <zeebe:output source="=providerOk" target="providerOk" />
          <zeebe:output source="=providerStatus" target="providerStatus" />
          <zeebe:output source="=providerRef" target="providerRef" />
          <zeebe:output source="=errorCode" target="errorCode" />
          <zeebe:output source="=errorMessage" target="errorMessage" />
          <zeebe:output source="=failedAtStep" target="failedAtStep" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_OrderOk_To_Provider</bpmn:incoming>
      <bpmn:outgoing>Flow_Provider_To_Gw_Provider</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:intermediateThrowEvent id="Event_ProviderFailed" name="Provider Failed">
      <bpmn:incoming>Flow_ProviderFail_To_ProviderFailed</bpmn:incoming>
      <bpmn:outgoing>Flow_ProviderFailed_To_EndJoin</bpmn:outgoing>
      <bpmn:outgoing>Flow_0ni831r</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:exclusiveGateway id="Gw_ProviderOk" name="Provider OK" default="Flow_ProviderFail_To_ProviderFailed">
      <bpmn:incoming>Flow_Provider_To_Gw_Provider</bpmn:incoming>
      <bpmn:outgoing>Flow_ProviderOk_To_Credit</bpmn:outgoing>
      <bpmn:outgoing>Flow_ProviderFail_To_ProviderFailed</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:serviceTask id="Task_SendNotification" name="Send Notification">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="mock.topup.notify.send" retries="3" />
        <zeebe:ioMapping>
          <zeebe:input source="=customerId" target="customerId" />
          <zeebe:input source="=paymentCorrelationId" target="paymentCorrelationId" />
          <zeebe:input source="=amount" target="amount" />
          <zeebe:input source="=currency" target="currency" />
          <zeebe:input source="=balanceAfter" target="balanceAfter" />
          <zeebe:input source="=paymentStatus" target="paymentStatus" />
          <zeebe:output source="=notifyOk" target="notifyOk" />
          <zeebe:output source="=notificationId" target="notificationId" />
          <zeebe:output source="=errorCode" target="errorCode" />
          <zeebe:output source="=errorMessage" target="errorMessage" />
          <zeebe:output source="=failedAtStep" target="failedAtStep" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_PersistOk_To_Notify</bpmn:incoming>
      <bpmn:outgoing>Flow_Notify_To_Gw_Notify</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:startEvent id="StartEvent_TopUp" name="Start">
      <bpmn:outgoing>Flow_1dl7hhq</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:intermediateThrowEvent id="Event_TopUpSuccess" name="TopUp Success">
      <bpmn:incoming>Flow_NotifyOk_To_Success</bpmn:incoming>
      <bpmn:outgoing>Flow_0r9564w</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
    <bpmn:serviceTask id="Task_LimitCheck" name="Transaction Limit Check">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="topup.limit.check" retries="3" />
        <zeebe:ioMapping>
          <zeebe:input source="=customerId" target="customerId" />
          <zeebe:input source="=accountId" target="accountId" />
          <zeebe:input source="=amount" target="amount" />
          <zeebe:input source="=currency" target="currency" />
          <zeebe:output source="=limitOk" target="limitOk" />
          <zeebe:output source="=limitRemaining" target="limitRemaining" />
          <zeebe:output source="=limitUsed" target="limitUsed" />
          <zeebe:output source="=limitTotal" target="limitTotal" />
          <zeebe:output source="=errorCode" target="errorCode" />
          <zeebe:output source="=errorMessage" target="errorMessage" />
          <zeebe:output source="=failedAtStep" target="failedAtStep" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_AccountOk_To_LimitCheck</bpmn:incoming>
      <bpmn:outgoing>Flow_1vfutif</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:exclusiveGateway id="Gw_ValidateOk" name="Validate OK" default="Flow_09935eq">
      <bpmn:incoming>Flow_0gsl0hg</bpmn:incoming>
      <bpmn:outgoing>Flow_ValidateOk_To_AccountStatus</bpmn:outgoing>
      <bpmn:outgoing>Flow_09935eq</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:serviceTask id="Task_ValidateRequest" name="Validate Requestee">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="topup.validate" retries="3" />
        <zeebe:ioMapping>
          <zeebe:input source="=customerId" target="customerId" />
          <zeebe:input source="=amount" target="amount" />
          <zeebe:input source="=currency" target="currency" />
          <zeebe:input source="=idempotencyKey" target="idempotencyKey" />
          <zeebe:input source="=accountId" target="accountId" />
          <zeebe:output source="=validateOk" target="validateOk" />
          <zeebe:output source="=errorCode" target="errorCode" />
          <zeebe:output source="=errorMessage" target="errorMessage" />
          <zeebe:output source="=failedAtStep" target="failedAtStep" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1dl7hhq</bpmn:incoming>
      <bpmn:outgoing>Flow_0gsl0hg</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:intermediateThrowEvent id="Event_ValidateFailed" name="Validation Failed">
      <bpmn:incoming>Flow_09935eq</bpmn:incoming>
      <bpmn:outgoing>Flow_ValidateFailed_To_EndJoin</bpmn:outgoing>
      <bpmn:outgoing>Flow_1jmuvxb</bpmn:outgoing>
    </bpmn:intermediateThrowEvent>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_TopUp">
    <bpmndi:BPMNPlane id="BPMNPlane_TopUp" bpmnElement="topup">
      <bpmndi:BPMNShape id="Shape_StartEvent_TopUp" bpmnElement="StartEvent_TopUp">
        <dc:Bounds x="152" y="112" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="158" y="148" width="25" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Task_ValidateRequest" bpmnElement="Task_ValidateRequest">
        <dc:Bounds x="260" y="88" width="160" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Gw_ValidateOk" bpmnElement="Gw_ValidateOk" isMarkerVisible="true">
        <dc:Bounds x="445" y="235" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="441" y="211" width="58" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Task_AccountStatus" bpmnElement="Task_AccountStatus">
        <dc:Bounds x="520" y="88" width="180" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Gw_AccountOk" bpmnElement="Gw_AccountOk" isMarkerVisible="true">
        <dc:Bounds x="735" y="235" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="730" y="211" width="59" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Task_LimitCheck" bpmnElement="Task_LimitCheck">
        <dc:Bounds x="830" y="88" width="180" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Gw_LimitOk" bpmnElement="Gw_LimitOk" isMarkerVisible="true">
        <dc:Bounds x="1035" y="235" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1038" y="211" width="43" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Task_OrderCreate" bpmnElement="Task_OrderCreate">
        <dc:Bounds x="1115" y="88" width="180" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Gw_OrderOk" bpmnElement="Gw_OrderOk" isMarkerVisible="true">
        <dc:Bounds x="1343" y="235" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1344" y="211" width="48" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Task_ProviderCharge" bpmnElement="Task_ProviderCharge">
        <dc:Bounds x="1435" y="88" width="170" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Gw_ProviderOk" bpmnElement="Gw_ProviderOk" isMarkerVisible="true">
        <dc:Bounds x="1635" y="235" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1629" y="211" width="61" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Task_CreditLedger" bpmnElement="Task_CreditLedger">
        <dc:Bounds x="1760" y="88" width="160" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Gw_CreditOk" bpmnElement="Gw_CreditOk" isMarkerVisible="true">
        <dc:Bounds x="1975" y="235" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1975" y="211" width="49" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Task_PersistResult" bpmnElement="Task_PersistResult">
        <dc:Bounds x="2085" y="88" width="170" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Gw_PersistOk" bpmnElement="Gw_PersistOk" isMarkerVisible="true">
        <dc:Bounds x="2315" y="235" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="2313" y="211" width="54" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Task_SendNotification" bpmnElement="Task_SendNotification">
        <dc:Bounds x="2420" y="90" width="170" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Gw_NotifyOk" bpmnElement="Gw_NotifyOk" isMarkerVisible="true">
        <dc:Bounds x="2623" y="235" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="2624" y="211" width="48" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Event_TopUpSuccess" bpmnElement="Event_TopUpSuccess">
        <dc:Bounds x="2732" y="110" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="2712" y="86" width="76" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Event_ValidateFailed" bpmnElement="Event_ValidateFailed">
        <dc:Bounds x="452" y="362" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="362" y="373" width="80" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Event_AccountFailed" bpmnElement="Event_AccountFailed">
        <dc:Bounds x="742" y="362" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="660" y="373" width="72" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Event_LimitFailed" bpmnElement="Event_LimitFailed">
        <dc:Bounds x="1042" y="362" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="974.5" y="373" width="57" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Event_OrderFailed" bpmnElement="Event_OrderFailed">
        <dc:Bounds x="1350" y="362" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1278" y="373" width="62" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Event_ProviderFailed" bpmnElement="Event_ProviderFailed">
        <dc:Bounds x="1642" y="362" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1558" y="373" width="74" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Event_CreditFailed" bpmnElement="Event_CreditFailed">
        <dc:Bounds x="1982" y="362" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1908.5" y="373" width="63" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Event_PersistFailed" bpmnElement="Event_PersistFailed">
        <dc:Bounds x="2322" y="362" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="2244.5" y="373" width="67" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Event_NotifyFailed" bpmnElement="Event_NotifyFailed">
        <dc:Bounds x="2630" y="362" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="2558" y="373" width="62" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Gw_EndJoin" bpmnElement="Gw_EndJoin" isMarkerVisible="true">
        <dc:Bounds x="2825" y="103" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="2828" y="79" width="43" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_EndEvent_TopUp" bpmnElement="EndEvent_TopUp">
        <dc:Bounds x="2942" y="110" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="2950" y="146" width="20" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Edge_Flow_ValidateOk_To_AccountStatus" bpmnElement="Flow_ValidateOk_To_AccountStatus">
        <di:waypoint x="495" y="260" />
        <di:waypoint x="550" y="260" />
        <di:waypoint x="550" y="168" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_AccountStatus_To_Gw_Account" bpmnElement="Flow_AccountStatus_To_Gw_Account">
        <di:waypoint x="670" y="168" />
        <di:waypoint x="670" y="264" />
        <di:waypoint x="739" y="264" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_AccountOk_To_LimitCheck" bpmnElement="Flow_AccountOk_To_LimitCheck">
        <di:waypoint x="781" y="264" />
        <di:waypoint x="860" y="264" />
        <di:waypoint x="860" y="168" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_LimitOk_To_OrderCreate" bpmnElement="Flow_LimitOk_To_OrderCreate">
        <di:waypoint x="1081" y="264" />
        <di:waypoint x="1155" y="264" />
        <di:waypoint x="1155" y="168" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_OrderOk_To_Provider" bpmnElement="Flow_OrderOk_To_Provider">
        <di:waypoint x="1393" y="260" />
        <di:waypoint x="1470" y="260" />
        <di:waypoint x="1470" y="168" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_Provider_To_Gw_Provider" bpmnElement="Flow_Provider_To_Gw_Provider">
        <di:waypoint x="1570" y="168" />
        <di:waypoint x="1570" y="260" />
        <di:waypoint x="1635" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_ProviderOk_To_Credit" bpmnElement="Flow_ProviderOk_To_Credit">
        <di:waypoint x="1685" y="260" />
        <di:waypoint x="1790" y="260" />
        <di:waypoint x="1790" y="168" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_ProviderFail_To_ProviderFailed" bpmnElement="Flow_ProviderFail_To_ProviderFailed">
        <di:waypoint x="1659" y="284" />
        <di:waypoint x="1659" y="362" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_Credit_To_Gw_Credit" bpmnElement="Flow_Credit_To_Gw_Credit">
        <di:waypoint x="1890" y="168" />
        <di:waypoint x="1890" y="260" />
        <di:waypoint x="1975" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_CreditOk_To_Persist" bpmnElement="Flow_CreditOk_To_Persist">
        <di:waypoint x="2025" y="260" />
        <di:waypoint x="2115" y="260" />
        <di:waypoint x="2115" y="168" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_Persist_To_Gw_Persist" bpmnElement="Flow_Persist_To_Gw_Persist">
        <di:waypoint x="2220" y="168" />
        <di:waypoint x="2220" y="264" />
        <di:waypoint x="2319" y="264" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_PersistOk_To_Notify" bpmnElement="Flow_PersistOk_To_Notify">
        <di:waypoint x="2365" y="260" />
        <di:waypoint x="2460" y="260" />
        <di:waypoint x="2460" y="170" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_Notify_To_Gw_Notify" bpmnElement="Flow_Notify_To_Gw_Notify">
        <di:waypoint x="2560" y="170" />
        <di:waypoint x="2560" y="260" />
        <di:waypoint x="2623" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_NotifyOk_To_Success" bpmnElement="Flow_NotifyOk_To_Success">
        <di:waypoint x="2673" y="260" />
        <di:waypoint x="2750" y="260" />
        <di:waypoint x="2750" y="146" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0gsl0hg_di" bpmnElement="Flow_0gsl0hg">
        <di:waypoint x="390" y="168" />
        <di:waypoint x="390" y="260" />
        <di:waypoint x="445" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_09935eq_di" bpmnElement="Flow_09935eq">
        <di:waypoint x="470" y="285" />
        <di:waypoint x="470" y="362" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0cw67z9_di" bpmnElement="Flow_0cw67z9">
        <di:waypoint x="760" y="285" />
        <di:waypoint x="760" y="362" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1vfutif_di" bpmnElement="Flow_1vfutif">
        <di:waypoint x="970" y="168" />
        <di:waypoint x="970" y="260" />
        <di:waypoint x="1035" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0s90190_di" bpmnElement="Flow_0s90190">
        <di:waypoint x="1368" y="285" />
        <di:waypoint x="1368" y="362" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_15v3udl_di" bpmnElement="Flow_15v3udl">
        <di:waypoint x="1260" y="168" />
        <di:waypoint x="1260" y="260" />
        <di:waypoint x="1343" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0r2ms3z_di" bpmnElement="Flow_0r2ms3z">
        <di:waypoint x="2000" y="285" />
        <di:waypoint x="2000" y="362" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_08fjqvi_di" bpmnElement="Flow_08fjqvi">
        <di:waypoint x="2340" y="285" />
        <di:waypoint x="2340" y="362" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1meuv2q_di" bpmnElement="Flow_1meuv2q">
        <di:waypoint x="2648" y="285" />
        <di:waypoint x="2648" y="362" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0r9564w_di" bpmnElement="Flow_0r9564w">
        <di:waypoint x="2768" y="128" />
        <di:waypoint x="2825" y="128" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0fc3unq_di" bpmnElement="Flow_0fc3unq">
        <di:waypoint x="2875" y="128" />
        <di:waypoint x="2942" y="128" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1jmuvxb_di" bpmnElement="Flow_1jmuvxb">
        <di:waypoint x="470" y="398" />
        <di:waypoint x="470" y="520" />
        <di:waypoint x="2850" y="520" />
        <di:waypoint x="2850" y="153" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1x35g4y_di" bpmnElement="Flow_1x35g4y">
        <di:waypoint x="760" y="398" />
        <di:waypoint x="760" y="520" />
        <di:waypoint x="2850" y="520" />
        <di:waypoint x="2850" y="153" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0c9zx24_di" bpmnElement="Flow_0c9zx24">
        <di:waypoint x="1060" y="285" />
        <di:waypoint x="1060" y="362" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_16bwcff_di" bpmnElement="Flow_16bwcff">
        <di:waypoint x="1060" y="398" />
        <di:waypoint x="1060" y="520" />
        <di:waypoint x="2850" y="520" />
        <di:waypoint x="2850" y="153" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1xrcphi_di" bpmnElement="Flow_1xrcphi">
        <di:waypoint x="1368" y="398" />
        <di:waypoint x="1368" y="520" />
        <di:waypoint x="2850" y="520" />
        <di:waypoint x="2850" y="153" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ni831r_di" bpmnElement="Flow_0ni831r">
        <di:waypoint x="1660" y="398" />
        <di:waypoint x="1660" y="520" />
        <di:waypoint x="2850" y="520" />
        <di:waypoint x="2850" y="153" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_18x9sla_di" bpmnElement="Flow_18x9sla">
        <di:waypoint x="2000" y="398" />
        <di:waypoint x="2000" y="520" />
        <di:waypoint x="2850" y="520" />
        <di:waypoint x="2850" y="153" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0k0fk85_di" bpmnElement="Flow_0k0fk85">
        <di:waypoint x="2340" y="398" />
        <di:waypoint x="2340" y="520" />
        <di:waypoint x="2850" y="520" />
        <di:waypoint x="2850" y="153" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0t8nc1l_di" bpmnElement="Flow_0t8nc1l">
        <di:waypoint x="2648" y="398" />
        <di:waypoint x="2648" y="520" />
        <di:waypoint x="2850" y="520" />
        <di:waypoint x="2850" y="153" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1dl7hhq_di" bpmnElement="Flow_1dl7hhq">
        <di:waypoint x="188" y="130" />
        <di:waypoint x="260" y="130" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>